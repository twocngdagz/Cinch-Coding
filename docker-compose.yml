services:
  catalog:
    build:
      context: ./catalog
      dockerfile: Dockerfile
    container_name: catalog_service
    environment:
      DB_CONNECTION: mysql
      DB_HOST: catalog_db
      DB_PORT: 3306
      DB_DATABASE: cinch_catalog
      DB_USERNAME: root
      DB_PASSWORD: root
    volumes:
      - ./catalog:/var/www/catalog
    ports:
      - "8001:8000"
    healthcheck:
      test:
        [
          "CMD",
          "php",
          "-r",
          "$$fp=@fsockopen('127.0.0.1',8000,$$e,$$s,2);if(!$$fp){exit(1);}fwrite($$fp,\"GET /up HTTP/1.1\\r\\nHost: localhost\\r\\nConnection: close\\r\\n\\r\\n\");$$resp=stream_get_contents($$fp);fclose($$fp);exit(strpos($$resp,\"200\")===false);",
        ]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 5s
    networks:
      - cinch
    depends_on:
      catalog_db:
        condition: service_healthy

  checkout:
    build:
      context: ./checkout
      dockerfile: Dockerfile
    container_name: checkout_service
    environment:
      DB_CONNECTION: mysql
      DB_HOST: checkout_db
      DB_PORT: 3306
      DB_DATABASE: cinch_checkout
      DB_USERNAME: root
      DB_PASSWORD: root
    volumes:
      - ./checkout:/var/www/checkout
    ports:
      - "8002:8000"
    healthcheck:
      test:
        [
          "CMD",
          "php",
          "-r",
          "$$fp=@fsockopen('127.0.0.1',8000,$$e,$$s,2);if(!$$fp){exit(1);}fwrite($$fp,\"GET /up HTTP/1.1\\r\\nHost: localhost\\r\\nConnection: close\\r\\n\\r\\n\");$$resp=stream_get_contents($$fp);fclose($$fp);exit(strpos($$resp,\"200\")===false);",
        ]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 5s
    networks:
      - cinch
    depends_on:
      checkout_db:
        condition: service_healthy
      catalog:
        condition: service_started

  email:
    build:
      context: ./email
      dockerfile: Dockerfile
    container_name: email_service
    environment:
      DB_CONNECTION: mysql
      DB_HOST: email_db
      DB_PORT: 3306
      DB_DATABASE: cinch_email
      DB_USERNAME: root
      DB_PASSWORD: root
      MAIL_MAILER: smtp
      MAIL_HOST: mailhog
      MAIL_PORT: 1025
    volumes:
      - ./email:/var/www/email
    ports:
      - "8003:8000"
    healthcheck:
      test:
        [
          "CMD",
          "php",
          "-r",
          "$$fp=@fsockopen('127.0.0.1',8000,$$e,$$s,2);if(!$$fp){exit(1);}fwrite($$fp,\"GET /up HTTP/1.1\\r\\nHost: localhost\\r\\nConnection: close\\r\\n\\r\\n\");$$resp=stream_get_contents($$fp);fclose($$fp);exit(strpos($$resp,\"200\")===false);",
        ]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 5s
    networks:
      - cinch
    depends_on:
      email_db:
        condition: service_healthy

  frontend:
    build:
      context: ./frontend
    container_name: frontend
    ports:
      - "8000:80"
    depends_on:
      - catalog
      - checkout
    networks:
      - cinch

  catalog_db:
    image: mysql:8.0
    container_name: catalog_db
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: cinch_catalog
    ports:
      - "3307:3306"
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "127.0.0.1", "-uroot", "-proot" ]
      interval: 5s
      timeout: 3s
      retries: 20
    networks:
      - cinch

  checkout_db:
    image: mysql:8.0
    container_name: checkout_db
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: cinch_checkout
    ports:
      - "3308:3306"
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "127.0.0.1", "-uroot", "-proot" ]
      interval: 5s
      timeout: 3s
      retries: 20
    networks:
      - cinch

  email_db:
    image: mysql:8.0
    container_name: email_db
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: cinch_email
    ports:
      - "3309:3306"
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "127.0.0.1", "-uroot", "-proot" ]
      interval: 5s
      timeout: 3s
      retries: 20
    networks:
      - cinch

  mailhog:
    image: mailhog/mailhog
    container_name: mailhog
    ports:
      - "8025:8025"
      - "1025:1025"
    networks:
      - cinch
networks:
  cinch:
    driver: bridge
